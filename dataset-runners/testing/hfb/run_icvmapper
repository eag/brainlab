#!/bin/bash

#===============================================================================
### REQUIREMENTS ###
#===============================================================================

# BRAINLAB_DIR, BLT_CONTAINER_DIR defined
# apptainer (or singularity symlinked to apptainer)
# FSL (fslcpgeom)

#-------------------------------------------------------------------------------
### VARIABLES ###
#-------------------------------------------------------------------------------

### data variables ###
BASE_DIR="${HOME}/tmp/test_datasets/dti/leducq"
IN_DIR="${BASE_DIR}/organized"
OUT_DIR="${BASE_DIR}/derivatives/icvmapper"
TMP_ROOT="${HOME}/tmp"
T1_FN=T1.nii.gz

#-------------------------------------------------------------------------------
### CONFIG ###
#-------------------------------------------------------------------------------

### standard variables ###
LIST_DIR=${OUT_DIR}/lists
LOG_DIR=${OUT_DIR}/logs
LIST_FN=${LIST_DIR}/subject_list.txt

### checks and paths ###

for var in BRAINLAB_DIR BLT_CONTAINER_DIR; do
  if [[ -z "${!var}" ]]; then
    echo "ERROR: $var not set"
    exit 1
  fi
done

export PATH=${PATH}:${BRAINLAB_DIR}/wrapper-scripts/bash/core

#-------------------------------------------------------------------------------
### FUNCTIONS ###
#-------------------------------------------------------------------------------

function prep_dir
{
  echo "Preparing directories..."
  
  mkdir -p ${LIST_DIR}
  mkdir -p ${OUT_DIR}

  rm -f ${LIST_FN}
  $(cd ${IN_DIR}; ls -d * | grep -Ev "lists" | grep -Ev "logs" > ${LIST_FN})
  while read -r line; do
    SUB_ID=$(echo ${line} | cut -d'/' -f1)
    mkdir -p ${OUT_DIR}/${SUB_ID}
  done < ${LIST_FN}
}
 
function icvmapper_t1
{
  bltIcvmapper \
    ${OUT_DIR}/${SUB_ID} \
    ${IN_DIR}/${SUB_ID}/${T1_FN} \
    -b --thr 0.4
}

#-------------------------------------------------------------------------------
### PROCESSING ###
#-------------------------------------------------------------------------------

if [[ $# -eq 0 ]]; then
  prep_dir
elif [[ $# -eq 1 ]]; then
  ### get subject ID from the list ###
  IDX=$1
  SUB_ID=$(cat ${LIST_FN} | head -n ${IDX} | tail -n 1)
  
  ### run container for subject ID ###
  icvmapper_t1
fi

#-------------------------------------------------------------------------------
